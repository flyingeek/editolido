<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Convertisseur OFP</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-836666-8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-836666-8', { 'anonymize_ip': true, 'allow_ad_personalization_signals': false });
    </script>
    <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" /-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap.min.css">
    <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="//unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" type="text/css">
    <link href="css/color-picker-min.css" rel="stylesheet">
    <style>
        legend input[type="checkbox"] {margin-bottom: 0.2rem; vertical-align: middle}
        #map { width:100%; height: 400px; margin: 1rem 0;}
        #gramet{margin: 1rem 0;}
        .custom-file-input:lang(fr)~.custom-file-label::after {
            content: "Sélectionner";
        }
        span[title]{border-bottom: 1px dashed;}

        .color-picker input {
            margin: 2px 0 0;
            padding: 0;
            display: block;
            width: 100%;
            cursor: ew-resize;
        }
        .color-picker {
            background-color: #fff;
            font-size:20px;
        }
        .color-picker i {
            font-size: 15px;
        }
        label + span.input-group-text{
            background-color: white;
            padding: 0 0 0 0.2rem;
            border-right: 0px;
        }
        span.input-group-text > svg{
            stroke: white;
            fill: white;
            height: 1.1rem;
            width: 1.1rem;
        }
        select.custom-select{
            border-left: 0px;
            padding-left: 0.2rem;
        }
        #results>h2{
            position: absolute;
        }
        #lido-route{
            padding-top: 2.5em;
        }
        .copied::after {
            position: absolute;
            top: 40%;
            left: 103%;
            display: block;
            content: "copié!";
            font-size: 0.35em;
            padding: 2px 3px;
            color: #fff;
            background-color: #1ea840;
            border-radius: 3px;
            opacity: 0;
            will-change: opacity, transform;
            animation: showcopied 1.5s ease;
        }

        @keyframes showcopied {
            0% {
                opacity: 0;
                transform: translateX(-100%);
            }
            70% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
            }
        }

        #shortcut>.input-group-prepend>span{
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            background-color: #1b1e5b;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAABK9JREFUSMe1VjuPHEUQrkf3zM7ePm6958dhH2djwGBkIyHeQoiIH0EAIiQg4wcQkTogIoMIRICEQEIgQQASCAJbxsIW+M68hM/n85ndmd2dnemuKgKDEHdrn0FHqYNSd6s+ler7qgqXlp8DQAAzAIQ/bUd/1uXsIPSX//fD7fizLmcHIfifzd3+VzENqgDgiBzSbgIoWFC5a27hxPwiApwbrK2Or3lkQtwFgGjqkV8++viLhx/tpS1D2gjjt3765o3Vr4LKjqlwd/7ELZ6nKouN1qnjzzx/6ASZ1VpPNTiCR/p3Hm3tOf375TxM+ZYYNwUwgFL0iV7/jQeefKy7t5RaIAqIWKw0TGR6R7PzUG9xZXT98rRgJPxXAGIQzF44uP/UfccPJH6qtYKoiUCMFmsNldZFrDzzyd7+PFQ/jYeIgIC3BRANGoSv3tN/5cg+Ro0WDcTgRvRQW6g0lBomUuWxKjUebs8z48+jXExxW9m3FlkN2g5ffyB7ts+l5AYpYGqWKCQCLpqrjSrFUmGsNhYZiuYS7+32BeyLtV+iKd4aoFJ46ZA9u68uwwgwAQhmtWIq4KO5Gl2tXCpMBMdihVghkseYi3TTZKndXh0O+J9JbKcpLmYRSIAULJpFxaAQxHzERsC0YiojjmM1iqEQy6MVIkWUUmWmKrYyjNHeu0yDGL2rlGqlqeJEcBKpClRVHEqWspGMu/OF46KeFLEswnQk1bAu18dj2lbnrUVmhF9K/Danx/vSS7QGE4KIVCNMESZII+Qcfe6bg/beoUKeXx9L/L2OK4PhKMTtbJ3BIoewOqJPN+hYW5fntEKqESvEEnmMnJMfcjqgbOhag95SkbbXr/x6cXNzIjpTC7N1wGAD8J/5fa2GO5ZUFeIEeUJuRElB6ZCzgWsOea7g5sX5+3/o3K1XL3E5AOKZACe3aljNdbL2XXut0/zcetc4O86lEuXsC05zzgaumXN2ndtn+eCPOG/dg7r8MOVXaLgGRDtkYGauk3XuP+BaCTU8Z/6c653383diSBBy1yhco+DsN7fwdbq85nvICSBBoyvLD9P69zTagH+2Jre9NTcPdRsLmQKoc8qOmc/zntdo4TEt+mAD6qz4Axf80gQzDyBACg4MLG3Fe57mtQtbiLkVwMzANO03VE2IhVnJMVNJjU+oB5gKNCPOGZAHFVA1Q0M1Ngc43tx5HhDTaHWzdWS+fd9CFIvIQixEgMBoAiagbCIgYgImZhFMDFP+4Yz/7mNgv9PAQdBa1j5ZkSh7nlpyALURAiICgRIYmqIKWESNqAEhQRH+5kP/xbsQw85FBgBENIXRxc04Du0H+77jzCMmCAmhJ/SMjv48iYe6ho/e5S8/BLDt0W+qA0RAwvLn4eTSYO54L1nMjAw8oEN0SI7IEaZe1zfC2+/AhbPgPdxkPs/Qwd8wTPW1sjh9NT2YZcfawAAMyIAJUYPDmZXJmx/Y+lXw/r/PZGTUMhZfr1uU7N4Wdx161HFVvH+ueOcrmNbg+NZDH5eWn9t5bzHQoMlis3G0Y4bVpTxcGaEj2JW15Qa1KKGwUYa1yY12iJ53f7NDQkgQ/qX9v7upAZBtXZZ30xDwD7OghDZGs+a6AAAAAElFTkSuQmCC");
        }
    </style>
</head>
<body>
<div class="container">
<h1>Convertisseur OFP</h1>
    <div class="input-group mb-3">
        <div class="input-group-prepend">
            <span class="input-group-text" id="file-label">OFP</span>
        </div>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="file" aria-describedby="file-label" accept="application/pdf">
            <label class="custom-file-label" for="file">Choisir un PDF</label>
        </div>
    </div>

    <div class="progress" style="visibility: hidden;">
        <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">Envoi du PDF...</div>
    </div>

<div id="results" style="display: none">
    <h2>Route Lido <a id="copy-route-button" class="btn btn-sm btn-outline-secondary">copier</a></h2>
    <div contenteditable="true" id="lido-route"></div>

    <textarea id="kml" style="width: 100%; height: 200px; display:none;"></textarea>
    <div id="gramet"></div>
    <div id="map"></div>
    <div>
    <a class="btn btn-success mb-2"
       id="download-kml-mapsme" href="" download="">Télécharger KML Mapsme</a>
    <a class="btn btn-success mb-2"
       id="download-kml-avenza" href="" download="">Télécharger KML Avenza</a>
        <div class="input-group mb-2" id="shortcut">
            <div class="input-group-prepend">
                <span class="input-group-text"></span>
            </div>
            <input type="text" class="form-control" placeholder="Nom du raccourci">
            <div class="input-group-append">
                <a class="btn btn-outline-secondary" href="">Lancer</a>
            </div>
        </div>
    </div>
    <small class="form-text text-muted">Il est possible de modifier dynamiquement le KML généré en modifiant les options ci-dessous.<span> Sur iOS, on peut préciser le nom d'un raccourci à exécuter. <a href="https://www.icloud.com/shortcuts/8833e7fb6e484ec7be86ab9bd8c056d7" target="_blank">Exemple de raccourci</a></span></small>
</div><!-- results -->
<form id="form-options" onsubmit="return false;" style="display: none">
    <fieldset class="form-group">
        <legend>Route</legend>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="route-color-label">Couleur</span>
                    </div>
                    <input name="route-color" type="text" value="FFDA25A8" class="form-control" id="route-color"
                           aria-describedby="route-color-label" data-color="#A825DA" >
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="route-pin">Repère</label>
                    </div>
                    <select name="route-pin" class="custom-select" id="route-pin" data-value="0">
                        <option value="0" selected>Aucun</option>
                        <option value="1">Bleu</option>
                        <option value="2">Jaune</option>
                        <option value="3">Marron* (Rouge pour Avenza)</option>
                        <option value="4">Orange</option>
                        <option value="5">Rose* (Rouge pour Avenza)</option>
                        <option value="6">Rouge</option>
                        <option value="7">Vert</option>
                        <option value="8">Violet</option>
                    </select>
                </div>
            </div>
        </div>
    </fieldset>
    <fieldset class="form-group">
        <legend><input type="checkbox" name="alternate-display" checked />
            Dégagement
        </legend>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="alternate-color-label">Couleur</span>
                    </div>
                    <input name="alternate-color" type="text" value="FFFF00FF" class="form-control" id="alternate-color"
                           aria-describedby="alternate-color-label" data-color="#FF00FF">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="alternate-pin">Repère</label>
                    </div>
                    <select name="alternate-pin" class="custom-select" id="alternate-pin" data-value="0">
                        <option value="0" selected>Aucun</option>
                        <option value="1">Bleu</option>
                        <option value="2">Jaune</option>
                        <option value="3">Marron* (Rouge pour Avenza)</option>
                        <option value="4">Orange</option>
                        <option value="5">Rose* (Rouge pour Avenza)</option>
                        <option value="6">Rouge</option>
                        <option value="7">Vert</option>
                        <option value="8">Violet</option>
                    </select>
                </div>
            </div>
        </div>
    </fieldset>
    <fieldset class="form-group">
        <legend><input type="checkbox" name="nat-display" checked />
            Tracks
        </legend>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="nat-color-label">Couleur</span>
                    </div>
                    <input name="nat-color" type="text" value="60DA25A8" class="form-control" id="nat-color"
                           aria-describedby="nat-color-label" data-color="#A825DA">

                </div>
                <small class="form-text text-muted">Un track incomplet sera toujours affiché en rouge.</small>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="nat-pin">Repère</label>
                    </div>
                    <select name="nat-pin" class="custom-select" id="nat-pin" data-value="8">
                        <option value="0">Aucun</option>
                        <option value="1">Bleu</option>
                        <option value="2">Jaune</option>
                        <option value="3">Marron* (Rouge pour Avenza)</option>
                        <option value="4">Orange</option>
                        <option value="5">Rose* (Rouge pour Avenza)</option>
                        <option value="6">Rouge</option>
                        <option value="7">Vert</option>
                        <option value="8" selected>Violet</option>
                    </select>
                </div>
                <small class="form-text text-muted">Le repère est placé à l'entrée des tracks.</small>
            </div>
        </div>
    </fieldset>
    <div class="row"><div class="col">
    <fieldset class="form-group">
        <legend><input type="checkbox" name="great-circle-display" checked />
            Orthodromie
        </legend>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="great-circle-color-label">Couleur</span>
                    </div>
                    <input name="great-circle-color" type="text" value="5F1478FF" class="form-control" id="great-circle-color"
                           aria-describedby="great-circle-color-label" data-color="#FF7814">
                </div>
            </div>
        </div>
    </fieldset></div><div class="col">
    <fieldset class="form-group">
        <legend><input type="checkbox" name="ogimet-display" checked />
            Route du GRAMET
        </legend>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="ogimet-color-label">Couleur</span>
                    </div>
                    <input name="ogimet-color" type="text" value="40FF0000" class="form-control" id="ogimet-color"
                           aria-describedby="ogimet-color-label" data-color="#0000FF">
                </div>
            </div>
        </div>
    </fieldset>
    </div></div>
    <!-- Button trigger modal -->
<button type="button" id="reset-kml-options-trigger" class="btn btn-secondary" data-toggle="modal" data-target="#reset-kml-options-modal">
  Restaurer...
</button>
    <button type="button" id="memorize-options-trigger" class="btn btn-primary">
  Mémoriser
</button>
<!-- Modal -->
<div class="modal fade" id="reset-kml-options-modal" tabindex="-1" role="dialog" aria-labelledby="reset-kml-options-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reset-kml-options-modal-title">Réinitialisation des paramètres</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="reset-kml-options-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="reset-kml-options-button-default" data-dismiss="modal">Valeurs par défaut</button>
        <button type="button" class="btn btn-primary" id="reset-kml-options-button-session" data-dismiss="modal">Valeurs mémorisées</button>
      </div>
    </div>
  </div>
</div>
</form>
    <br>
<p>Ce convertisseur utilise les librairies <a href="https://github.com/flyingeek/editolido">editolido</a> et <a href="https://github.com/flyingeek/lidojs">lidojs</a>. <small>v1.0.4j</small></p>
</div><!--end of container-->
<script src="js/lidojs-1.0.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap.native/2.0.25/bootstrap-native-v4.min.js"></script>
<!--script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script-->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js'></script>
<!-- https://github.com/elmarquis/Leaflet.GestureHandling -->
<script src="//unpkg.com/leaflet-gesture-handling"></script>
<script src="js/color-picker-min.js"></script>
<script>
    const dataURL = function(str, type="application/vnd.google-earth.kml+xml"){
        return "data:" + type + ";base64," +btoa(unescape(encodeURIComponent(str)));
    };
    const filename = function(str, extension=".kml"){
        if (!str) {
            return "";
        }
        str = str.trim();
        return str.replace(/[ \/]/g, "_").replace(/:/g, '') + extension
    }
    const downloadKml = function(e, kml, name){
        e.target.href = dataURL(kml);
        e.target.setAttribute("download",name);
        if (!!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform)){
            e.target.setAttribute("target", "_blank");
        }else if(e.target.hasAttribute("target")){
            e.target.removeAttribute("target");
        }
    }
    document.getElementById('download-kml-mapsme').onclick = function(e) {
        downloadKml(e, document.getElementById('kml').value, filename(kmlDescription + '_mapsme'));
    }
    document.getElementById('download-kml-avenza').onclick = function(e) {
        kmlGen.template = editolido.avenzaTemplate;
        kmlGen.styleTemplate = editolido.avenzaStyleTemplate;
        kmlGen.iconTemplate = editolido.avenzaIconTemplate;
        kmlGen.icons = editolido.AVENZAICONS;
        downloadKml(e, kmlGen.render({"name": kmlDescription}), filename(kmlDescription + '_avenza'));
    }
    let map = undefined;
    const shortcutNameInput = document.querySelector('#shortcut input[type="text"]');
    if (!!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform)){
        document.getElementById('shortcut').style.display="flex";
    }else{
        document.getElementById('shortcut').style.display="none";
        document.querySelector('#results small.form-text span').style.display="none";
    }
    const shortcutLink = document.querySelector('#shortcut a');
    let shortcutName = localStorage.getItem("shortcut");
    if (shortcutName){
        shortcutNameInput.value = shortcutName;
    }else{
        shortcutLink.style.display="none";
    }
    shortcutNameInput.onchange = function(e){
        if(this.value.trim()){
            shortcutName = this.value.trim();
            localStorage.setItem("shortcut", shortcutName);
        }else{
            shortcutName = undefined;
            localStorage.removeItem("shortcut");
        }
    };
    shortcutNameInput.oninput = function(e){
        if(this.value.trim()){
            shortcutLink.style.display="inline-block";
        }else{
            shortcutLink.style.display="none";
        }
    };
    shortcutLink.onclick=function(e){
        kmlGen.template = editolido.avenzaTemplate;
        kmlGen.styleTemplate = editolido.avenzaStyleTemplate;
        kmlGen.iconTemplate = editolido.avenzaIconTemplate;
        kmlGen.icons = editolido.AVENZAICONS;
        const obj = {
            "lidoRoute": document.getElementById('lido-route').innerText,
            "kml": document.getElementById('kml').value,
            "kmlAvenza": kmlGen.render({"name": kmlDescription}),
            "grametProxyURL":document.querySelector("#gramet img").src
        }
        this.href="shortcuts://run-shortcut?name=" + encodeURIComponent(shortcutName) + "&input=text&text=" + encodeURIComponent(JSON.stringify(obj));
    };
    let customLayer = L.geoJson(null, {
        // http://leafletjs.com/reference.html#geojson-style
        style: function (feature) {
            function style(value) {
                const color = "#" + value.substring(6, 8) + value.substring(4, 6) + value.substring(2, 4);
                const opacity = parseInt(value.substring(0, 2), 16) / 255;
                return {color, opacity, "weight": 2};
            }

            const defaultOptions = {"weight": 1, "opacity": 1.0}
            switch (feature.properties.styleUrl) {
                case '#rmain':
                    return style(formOptions["route-color"].value);
                case '#rnat':
                    return style(formOptions["nat-color"].value);
                case '#rnat_incomplete':
                    return style(kmlOptions.natIncompleteColor);
                case '#ogimet':
                    return style(formOptions["ogimet-color"].value);
                case '#ralt':
                    return style(formOptions["alternate-color"].value);
                case '#greatcircle':
                    return style(formOptions["great-circle-color"].value);
                default:
                    return {"color": '#f00', "weight": 1, "opacity": 1.0};
            }

        },
        pointToLayer: function (geoJsonPoint, latlng) {
            if (geoJsonPoint.properties.styleUrl.substring(0, 11) === '#placemark-') {
                const i = editolido.PINS.indexOf(geoJsonPoint.properties.styleUrl);
                return L.marker(latlng, {"icon": mapIcons[i]});
            }
            return L.marker(latlng);
        }
    });
    const kmlGen = new editolido.KMLGenerator();
    let kmlDescription = undefined;
    const debounce = (func, delay) => {
        let inDebounce;
        return function () {
            const context = this;
            const args = arguments;
            //console.log(context, args);
            clearTimeout(inDebounce);
            inDebounce = setTimeout(() => func.apply(context, args), delay);
        }
    };

    const updateKml = function(){
        const downloadButtons = document.querySelectorAll("a[download]");
        const shortcutDisplay = shortcutLink.style.display;
        downloadButtons.forEach(elt => elt.classList.add('disabled'));
        shortcutLink.style.display="none";
        kmlGen.template = editolido.template;
        kmlGen.styleTemplate = editolido.styleTemplate;
        kmlGen.iconTemplate = editolido.iconTemplate;
        kmlGen.icons = editolido.GOOGLEICONS;
        document.getElementById('kml').value = kmlGen.render({"name": kmlDescription});
        downloadButtons.forEach(elt => elt.classList.remove('disabled'));
        shortcutLink.style.display=shortcutDisplay;
    };

    const clearMap = function() {
        if (map !==undefined) {
            if (map.hasLayer(customLayer)) {
                map.removeLayer(customLayer);
            }
            customLayer.clearLayers();
        }
    }

    const addKmlToMap = function(kml){
        if (map !== undefined) {
            omnivore.kml.parse(kml, null, customLayer);
            customLayer.addTo(map);
        }
    }

    const updateMap = function(kml) {
        clearMap();
        addKmlToMap(kml);
    }

    const updateDOM = function(){
        if (JSON.stringify(kmlOptions) === JSON.stringify(kmlDefaultOptions) && JSON.stringify(kmlOptions) === JSON.stringify(readOptions())){
            document.getElementById('reset-kml-options-trigger').style.display = "none";
        }else{
            document.getElementById('reset-kml-options-trigger').style.display = "inline-block";
        }
        if (JSON.stringify(kmlOptions) === JSON.stringify(readOptions())){
            document.getElementById('memorize-options-trigger').style.display = "none";
        }else{
            document.getElementById('memorize-options-trigger').style.display = "inline-block";
        }
    }

    const update = function(){
        updateKml();
        updateMap(document.getElementById('kml').value);
        updateDOM();
    }

    const debounceUpdate = function(delay=1000){
        const downloadButtons = document.querySelectorAll("a[download]");
        downloadButtons.forEach(elt => elt.classList.add('disabled'));
        debounce(function(){
            updateKml();
            updateMap(document.getElementById('kml').value);
        }, delay)();
        updateDOM();
    }

    const formOptions = document.getElementById('form-options');
    const kmlDefaultOptions = {
        "routePin":"0",
        "routeColor":"FFDA25A8",
        "alternateDisplay":true,
        "alternatePin":"0",
        "alternateColor":"FFFF00FF",
        "natDisplay":true,
        "natPin":"8",
        "natPinPosition":0,
        "natColor":"80DA25A8",
        "natIncompleteColor":"FF0000FF",
        "greatCircleDisplay":true,
        "greatCircleColor":"5F1478FF",
        "ogimetDisplay":true,
        "ogimetColor":"40FF0000"
    };
    function readOptions(){
        return JSON.parse(localStorage.getItem("optionsKML")) || {... kmlDefaultOptions};
    }
    let kmlOptions = readOptions();
    function camelCaseToDash(str) {
        return str.replace(/([a-zA-Z])(?=[A-Z])/g, '$1-').toLowerCase()
    }
    function dashToCamelCase(str){
        return str.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });
    }
    function folder(str){
        const a = str.split('-');
        const name = a.slice(0, -1).join('');
        switch (name){
            case "route":
                return "rmain";
            case "alternate":
                return "ralt";
            case "nat":
                return "rnat";
            default:
                return name;
        }
    }
    function updateOptionsForm(options){
        for(const key in options) {
            const formKey = camelCaseToDash(key);
            const keyType = formKey.split('-').pop();
            const constants = ['natPinPosition', 'natIncompleteColor'];
            const event = new Event('change');
            if (constants.indexOf(key) !== -1){
                continue;
            }
            switch (keyType) {
                case "display":
                    formOptions[formKey].checked = options[key];
                    formOptions[formKey].dispatchEvent(event);
                    continue;
                case "pin":
                    formOptions[formKey].value = options[key];
                    formOptions[formKey].dispatchEvent(event);
                    continue;
                case "color":
                    formOptions[formKey].value = options[key];
                    formOptions[formKey].dispatchEvent(event);
                    continue;
                default:
                    continue;
            }
        }
    }
    let mapIcons = [0 ,1 ,2 ,3 ,4 ,5 ,6 ,7 ,8 ].map(c => `https://flyingeek.github.io/editolido/img/pin${c}.png`);
    kmlGen.addFolders(
        {"name": "greatcircle", "enabled": kmlOptions.greatCircleDisplay, "color": kmlOptions.greatCircleColor},
        {"name": "ogimet", "enabled": kmlOptions.ogimetDisplay, "color": kmlOptions.ogimetColor},
        {"name": "ralt", "enabled": kmlOptions.alternateDisplay, "color": kmlOptions.alternateColor, "pinId": kmlOptions.alternatePin},
        {"name": "rmain", "color": kmlOptions.routeColor, "pinId": kmlOptions.routePin},
        {"name": "rnat", "enabled": kmlOptions.natDisplay, "color": kmlOptions.natColor, "pinId": kmlOptions.natPin},
        {"name": "rnat_incomplete", "enabled": kmlOptions.natDisplay, "color": kmlOptions.natIncompleteColor, "pinId": kmlOptions.natPin}
    );

    class KMLCP {
        constructor(elt) {
            this.picker = new CP(elt);
            this.alpha = document.createElement('input');
            this.alpha.type = 'range';
            this.alpha.min = 0;
            this.alpha.max = 255;
            this.alpha.step = 1;
            this.alpha.value = 255; // opaque
            const picker = this.picker;
            const alpha = this.alpha;
            this.alpha.onchange = function (e) {
                const color = CP._HSV2HEX(picker.set()).toUpperCase();
                const r = color.slice(0, 2);
                const g = color.slice(2, 4);
                const b = color.slice(4, 6);
                const a = Number(e.target.value).toString(16).toUpperCase();
                picker.source.value = a + b + g + r;
                picker.source.setAttribute('data-color', '#' + r + g + b);
                picker.source.style.backgroundColor = "#" + r + g + b + a;
                KMLCP.adaptTextColor(picker.source, r, g, b);
            };
            this.alpha.oninput = this.alpha.onchange;
            picker.self.appendChild(this.alpha);
            picker.on("change", function (color) {
                color = color.toUpperCase();
                const r = color.slice(0, 2);
                const g = color.slice(2, 4);
                const b = color.slice(4, 6);
                const a = Number(alpha.value).toString(16).toUpperCase();
                this.source.value = a + b + g + r;
                this.source.setAttribute('data-color', '#' + r + g + b);
                this.source.style.backgroundColor = "#" + r + g + b + a;
                KMLCP.adaptTextColor(this.source, r, g, b);
            });
            picker.on("create", function (e) {
                const color = this.source.value.toUpperCase();
                alpha.value = parseInt(color.slice(0, 2), 16);
            });
            picker.source.addEventListener('change', function (e) {
                const color = e.target.value.toUpperCase();
                const a = color.slice(0, 2);
                const b = color.slice(2, 4);
                const g = color.slice(4, 6);
                const r = color.slice(6, 8);
                alpha.value = parseInt(a, 16);
                picker.set('#' + r + g + b)
                e.target.setAttribute('data-color', '#' + r + g + b);
                e.target.style.backgroundColor = "#" + r + g + b + a;
            });
        }
        static kml2rgb(value){
            const b = value.slice(2, 4);
            const g = value.slice(4, 6);
            const r = value.slice(6, 8);
            return "#" + r + g + b;
        }
        static adaptTextColor(selector, r, g, b) {
            r = parseInt(r, 16);
            g = parseInt(g, 16);
            b = parseInt(b, 16);
            var hsp = Math.sqrt(
                0.299 * (r * r) +
                0.587 * (g * g) +
                0.114 * (b * b)
            );
            if (hsp > 127.5) {
                selector.style.color = '#000';
            } else {
                selector.style.color = '#FFF';
                ;
            }
        }
    }

    document.querySelectorAll('input[data-color]').forEach(elt => {
        picker = new KMLCP(elt).picker;
        picker.on("exit", function() {
            kmlGen.changeFolderColor(folder(this.source.getAttribute('name')), this.source.value);
            kmlOptions[dashToCamelCase(this.source.getAttribute('name'))] = this.source.value;
            debounceUpdate();
        });
    });
    document.querySelectorAll('select[data-value]').forEach(e => {
        const colors = ['#FFFFFF', '#6699FF', '#FFFF00', '#CC9966', '#FF9922', '#DD5599', '#FF0000', '#22DD44', '#BB11EE'];
        const tpl = `<span class="input-group-text"><svg style="stroke: ${(e.value === "0") ? '#fff': '#000' }; fill: ${colors[e.value]}" mlns="http://www.w3.org/2000/svg" viewBox="0 0 64.723 100"><path d="M32.333 0C14.462 0 0 14.519 0 32.39c0 20.343 14.711 27.647 20.052 35.519S31.39 84.438 32.333 100c.944-15.518 6.19-23.074 11.995-32.092 5.806-9.018 20.395-17.648 20.395-35.519S50.203 0 32.333 0zm.028 26.114a5.797 5.797 0 1 1 0 11.594 5.797 5.797 0 0 1 0-11.594z"/></svg></span>`;
        document.querySelector("label[for='" + e.id + "']").insertAdjacentHTML('afterend', tpl);
        e.addEventListener('change', function () {
            const svg = document.querySelector("label[for='" + this.id + "'] + span svg");
            svg.style.fill = colors[this.value];
            svg.style.stroke = (this.value === "0") ? '#fff': '#000';
            this.setAttribute('data-value', this.value);
            kmlOptions[dashToCamelCase(this.getAttribute('name'))] = this.value;
            kmlGen.changeFolderPin(folder(this.getAttribute('name')), parseInt(this.value, 10));
            debounceUpdate();
        })
    });
    document.querySelectorAll("legend > input[type='checkbox']").forEach(e => {
        e.addEventListener('change', function(){
            kmlGen.changeFolderState(folder(this.getAttribute('name')), this.checked);
            kmlOptions[dashToCamelCase(this.getAttribute('name'))] = this.checked;
            debounceUpdate();
        });
    })
    updateOptionsForm(kmlOptions);

    document.getElementById('reset-kml-options-modal').addEventListener('show.bs.modal', e =>{
        let text = "";
        const savedOptions = JSON.stringify(readOptions());
        if (JSON.stringify(kmlOptions) === savedOptions ||  savedOptions === JSON.stringify(kmlDefaultOptions)){
            text = "Il est possible de réinitialiser les paramètres aux valeurs par défaut";
            document.getElementById('reset-kml-options-button-session').style.display = "none";
        }else{
            text = "Il est possible de réinitialiser les paramètres aux valeurs par défaut, où aux valeurs mémorisées."
            document.getElementById('reset-kml-options-button-session').style.display = "inline-block";
        }
        document.getElementById('reset-kml-options-body').innerText = text;
    });
    document.getElementById('reset-kml-options-button-default').addEventListener('click', e=> {
        kmlOptions = {... kmlDefaultOptions};
        localStorage.removeItem("optionsKML");
        updateOptionsForm(kmlOptions);
        update();
    });
    document.getElementById('reset-kml-options-button-session').addEventListener('click', e=> {
        const modal = document.getElementById("reset-kml-options-modal");
        kmlOptions = readOptions();
        updateOptionsForm(kmlOptions);
        update();
    });
    document.getElementById('memorize-options-trigger').addEventListener('click', e => {
        const element = e.target;
        const text = element.innerText;
        const width = element.clientWidth;
        element.style['min-width'] = width + 'px';
        element.disabled = true;
        localStorage.setItem("optionsKML", JSON.stringify(kmlOptions));
        element.classList.remove("btn-primary");
        element.classList.add("btn-success");
        element.innerText = "✓";
        setTimeout(() => {
            element.style.display = "none";
            element.classList.add("btn-primary");
            element.classList.remove("btn-success");
            element.innerText = text;
            element.disabled = false;
        }, 1000);
    });
    function copyRoute(node=document.getElementById('lido-route')){
        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(node);
        selection.removeAllRanges();
        selection.addRange(range);
        document.execCommand("copy");
        selection.removeAllRanges();
        node.blur();
    }
    if (navigator.platform === "iPad") {
        const anchor = document.getElementById('copy-route-button');
        anchor.href = "lhs-mpilot://";
        anchor.innerText = "envoyer"
        anchor.onclick = function(e){
            copyRoute();
        };
    }else{
        const anchor = document.getElementById('copy-route-button');
        anchor.onclick = function(e){
            copyRoute();
            anchor.parentElement.classList.add('copied');
            setTimeout(function () {
                anchor.parentElement.classList.remove('copied');
            }, 1500);
            return false;
        };
    };
    function uploadForm(formData){
        const progressBar = document.getElementById('uploadProgress');
        const results = document.getElementById("results");
        const kml = document.getElementById("kml");
        progressBar.innerText = "Envoi en cours...";
        progressBar.parentElement.style.visibility = "visible";
        //myHeaders.append("X-Requested-With", "XMLHttpRequest");
        const downloadButtons = document.querySelectorAll("a[download]");
        downloadButtons.forEach(elt => elt.style.display = "none");
        kml.value = "uploading...";
        if (map !==undefined) {
            kmlGen.reset();
            clearMap();
        }
        axios.post("https://editolido.alwaysdata.net/mapsme", formData, {
            headers: {
                "Content-Type": "multipart/form-data",
                "X-Requested-With": "XMLHttpRequest"
            },
            onUploadProgress: progressEvent => {
                let value = (progressEvent.loaded / progressEvent.total) * 100;
                value = value.toFixed(0);
                progressBar.setAttribute("aria-valuenow", value);
                progressBar.style.width = value + "%";
            }
        })

            .then(function (response) {
                progressBar.innerText = "Conversion...";
                results.style.display = "block";
                return response.data;
            })
            .then(function (data) {
                //console.log(data);
                const routeName = `${data.infos.departure}-${data.infos.destination}`;
                const route = new editolido.Route(
                    data.wpt_coordinates.map(o => new editolido.GeoPoint(o)),
                    {"name": routeName, "description": data.description}
                );
                const alternateRoute = new editolido.Route(
                    data.wpt_coordinates_alternate.map(o => new editolido.GeoPoint(o)),
                    {"name": "Route Dégagement"}
                );
                const greatCircle = new editolido.Route(
                    [route.points[0], route.points[route.points.length -1]]
                ).split(300, {"name": `Ortho ${routeName}`});

                const ogimetRoute = new editolido.Route(
                    data.ogimet_route.points.map(o => new editolido.GeoPoint(o)),
                    {"name": data.ogimet_route.name, "description": data.ogimet_route.description}
                );

                const ogimetFPL = ogimetRoute.points.reduce((res, point) => {
                    if (point.name) {
                        return res ? res + "_" + point.name : point.name;
                    }
                    return res;
                }, "");
                document.getElementById("lido-route").innerText = data.lido_route;
                kmlDescription = data.description;
                let tracks = [];
                for (let t of data.tracks) {
                    tracks.push(
                        new editolido.Track(
                            t.points.map(o => new editolido.GeoPoint(o)),
                            {
                                "name": t.name,
                                "description": t.description,
                                "isMine": t.is_mine,
                                "isComplete": t.is_complete
                            }
                        )
                    );
                }
                let natmarks = [];
                for (let track of tracks){
                    let folder = track.isComplete ? 'rnat' : 'rnat_incomplete';
                    kmlGen.addLine(folder, track);
                    let p = new editolido.GeoPoint(track.points[0], {"name": track.name, "description": track.description});
                    kmlGen.addPoint(folder, p);
                    if (track.isMine){
                        natmarks.push(p);
                        p = new editolido.GeoPoint(track.points[track.points.length -1], {"name": track.name, "description": track.description});
                        natmarks.push(p);
                        kmlGen.addPoint(folder, p);
                    }
                }
                kmlGen.addLine('greatcircle', greatCircle);
                kmlGen.addLine('rmain', route);
                kmlGen.addPoints('rmain', route, {'excluded': natmarks});
                kmlGen.addLine('ralt', alternateRoute);
                kmlGen.addLine('ogimet', ogimetRoute);
                kmlGen.addPoints('ralt', alternateRoute);

                updateKml();
                progressBar.parentElement.style.visibility = "hidden";
                downloadButtons.forEach(elt => elt.style.display = "inline-block");
                formOptions.style.display="block";

                L.mapbox.accessToken = data.mapbox_token;
                if (map === undefined) {
                    //map =  L.map('map').setView([48.53, 2.14], 10);
                    map = L.mapbox.map('map', 'mapbox.streets', {
                        gestureHandling: true
                    });
                }
                addKmlToMap(kml.value)
                map.fitBounds(customLayer.getBounds());
                const tpl = `
<div id="gramet_route" contenteditable="true" style="display:none;">${ogimetFPL}</div>
<img src="${data.gramet_proxy}" alt="gramet image" class="img-fluid">
<small class="form-text text-muted">
    Gramet généré par <a href="${data.ogimet_url}" target="_blank">www.ogimet.com</a>,
    à partir d'une <span title="${ogimetFPL}">route proche</span> de celle de l'OFP.
    <a href="http://www.ogimet.com/guia_gramet.phtml.en" target="_blank">Guide d'interprétation</a>.
</small>`;
                document.getElementById("gramet").innerHTML = tpl;

            })
    }
    function createForm(file){
        const formData = new FormData();
        formData.append('pdf', file);
        return formData;
    }
    document.getElementById('file').addEventListener('change', function (e) {
        const filename = e.target.value.split(/([\\/])/g).pop();
        document.querySelector('label[for="file"]').innerHTML=filename;
        uploadForm(createForm(e.target.files[0]));
        gtag('event', 'upload', {
          'event_category': 'interaction',
          'event_label': filename,
          'value': 1
        });
    });
</script>
</body>
</html>
